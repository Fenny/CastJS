"use strict";function _instanceof(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function _classCallCheck(e,t){if(!_instanceof(e,t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}var Castjs=function(){function e(){var t=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(_classCallCheck(this,e),!window.chrome)return console.warn("Castjs: Casting is not supported in this browser");this.receiver=i.receiver||"CC1AD845",this.joinpolicy=i.joinpolicy||"origin_scoped",this.available=!1,this.session=null,this.player=null,this.controller=null,this.events={},this.template={source:null,poster:null,title:null,description:null,subtitles:[],volume:1,muted:!1,paused:!1,progress:0,time:"00:00:00",duration:"00:00:00",state:"disconnected"},this.media=Object.assign({},this.template);var r=setInterval(function(){window.chrome.cast&&window.chrome.cast.isAvailable&&(clearInterval(r),cast.framework.CastContext.getInstance().setOptions({receiverApplicationId:t.receiver,autoJoinPolicy:t.joinpolicy}),t.player=new cast.framework.RemotePlayer,t.controller=new cast.framework.RemotePlayerController(t.player),t.controller.addEventListener("isConnectedChanged",t.controller_isConnectedChanged.bind(t)),t.controller.addEventListener("currentTimeChanged",t.controller_currentTimeChanged.bind(t)),t.controller.addEventListener("durationChanged",t.controller_durationChanged.bind(t)),t.controller.addEventListener("volumeLevelChanged",t.controller_volumeLevelChanged.bind(t)),t.controller.addEventListener("isMutedChanged",t.controller_isMutedChanged.bind(t)),t.controller.addEventListener("isPausedChanged",t.controller_isPausedChanged.bind(t)),t.controller.addEventListener("playerStateChanged",t.controller_playerStateChanged.bind(t)),t.available=!0,t.trigger("available"))},250)}return _createClass(e,[{key:"controller_isConnectedChanged",value:function(){var e=this;setTimeout(function(){if(e.session=e.player.isConnected,e.session&&e.player.isMediaLoaded){for(var t in e.media={src:e.player.mediaInfo.contentId,poster:e.player.imageUrl||null,title:e.player.title||null,description:e.player.mediaInfo.metadata.subtitle||null,subtitles:[],progress:e.controller.getSeekPosition(e.player.currentTime,e.player.duration),time:e.controller.getFormattedTime(e.player.currentTime),duration:e.controller.getFormattedTime(e.player.duration),volume:e.player.volumeLevel,muted:e.player.isMuted,paused:e.player.isPaused,state:e.player.playerState.toLowerCase()},e.player.mediaInfo.tracks)"TEXT"===e.player.mediaInfo.tracks[t].type&&e.media.subtitles.push({label:e.player.mediaInfo.tracks[t].name,src:e.player.mediaInfo.tracks[t].trackContentId});var i=cast.framework.CastContext.getInstance().getCurrentSession().getSessionObj().media[0].activeTrackIds;i.length&&e.media.subtitles[i[0]]&&(e.media.subtitles[i[0]].active=!0),e.trigger("session",e.media)}})}},{key:"controller_currentTimeChanged",value:function(){this.media.progress=this.controller.getSeekPosition(this.player.currentTime,this.player.duration),this.media.time=this.controller.getFormattedTime(this.player.currentTime),this.media.duration=this.controller.getFormattedTime(this.player.duration),this.trigger("time",{progress:this.media.progress,time:this.media.time,duration:this.media.duration}),this.media.progress>=100&&(this.trigger("end"),this.disconnect())}},{key:"controller_durationChanged",value:function(){this.media.duration=this.player.duration}},{key:"controller_volumeLevelChanged",value:function(){this.media.volume=this.player.volumeLevel,this.trigger("volume",this.media.volume)}},{key:"controller_isMutedChanged",value:function(){this.media.muted=this.player.isMuted,this.trigger("muted",this.media.muted)}},{key:"controller_isPausedChanged",value:function(){this.media.paused=this.player.isPaused,this.trigger("pause",this.media.paused)}},{key:"controller_playerStateChanged",value:function(){this.media.state=this.player.playerState.toLowerCase(),"idle"===this.media.state&&(this.media.state="disconnected"),this.trigger("state",this.media.state)}},{key:"on",value:function(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}},{key:"off",value:function(e,t){if(!e)return this.events={};if(this.events[e]){if(void 0===t)return this.events[e]=[];for(var i in this.events[e])if(this.events[e][i]===t){this.events[e].splice(i,1);break}}}},{key:"trigger",value:function(e,t){for(var i in this.events[e])this.events[e][i](t)}},{key:"cast",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e)return this.trigger("error","No media source specified.");for(var r in i.source=e,i)i.hasOwnProperty(r)&&(this.media[r]=i[r]);cast.framework.CastContext.getInstance().requestSession().then(function(){if(!cast.framework.CastContext.getInstance().getCurrentSession())return t.trigger("error","Could not connect with the cast device");var e=new chrome.cast.media.MediaInfo(t.media.source);if(e.metadata=new chrome.cast.media.GenericMediaMetadata,t.media.subtitles.length){e.textTrackStyle=new chrome.cast.media.TextTrackStyle,e.textTrackStyle.fontFamily="Arial",e.textTrackStyle.foregroundColor="#FFFFFF",e.textTrackStyle.backgroundColor="#00000000",e.textTrackStyle.fontScale="1.1",e.textTrackStyle.edgeColor="#00000099",e.textTrackStyle.edgeType="DROP_SHADOW";var i=[];for(var r in t.media.subtitles){var n=new chrome.cast.media.Track(r,"TEXT");n.trackContentId=t.media.subtitles[r].src,n.trackContentType="text/vtt",n.subtype="CAPTIONS",n.name=t.media.subtitles[r].label,i.push(n)}e.tracks=i}e.metadata.images=[{url:t.media.poster}],e.metadata.title=t.media.title,e.metadata.subtitle=t.media.description;var a=new chrome.cast.media.LoadRequest(e);if(a.currentTime=t.media.time,a.autoplay=!t.media.paused,t.media.subtitles.length)for(var r in t.media.subtitles)if(t.media.subtitles[r].active){a.activeTrackIds=[r];break}cast.framework.CastContext.getInstance().getCurrentSession().loadMedia(a).then(function(){return t.trigger("connected"),t.trigger("session",t.media),t},function(e){return t.trigger("error",e),t})},function(e){return t.trigger("error",e),t})})},{key:"seek",value:function(e){return this.player.currentTime=this.controller.getSeekTime(e,this.player.duration),this.controller.seek(),this}},{key:"volume",value:function(e){return this.player.volumeLevel=e,this.controller.setVolumeLevel(),this}},{key:"play",value:function(){return this.media.paused&&this.controller.playOrPause(),this}},{key:"pause",value:function(){return this.media.paused||this.controller.playOrPause(),this}},{key:"mute",value:function(e){return!0===e&&!1===this.media.muted?this.controller.muteOrUnmute():!1===e&&!0===this.media.muted&&this.controller.muteOrUnmute(),this}},{key:"subtitle",value:function(e){var t=new chrome.cast.media.EditTracksInfoRequest([e]);for(var i in cast.framework.CastContext.getInstance().getCurrentSession().getSessionObj().media[0].editTracksInfo(t,null,null),this.media.subtitles)delete this.media.subtitles[i].active,i===e&&(this.media.subtitles[i].active=!0);return this}},{key:"disconnect",value:function(){return cast.framework.CastContext.getInstance().endCurrentSession(!0),this.controller.stop(),this.media=Object.assign({},this.template),this.session=!1,this.media.state="disconnected",this.trigger("disconnected"),this}}]),e}();
